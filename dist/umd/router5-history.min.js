!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("router5HistoryPlugin",t):e.router5HistoryPlugin=t()}(this,function(){"use strict";var e={};e["extends"]=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e};var t=function(e){return function(){return e}},n=function(){},a="undefined"!=typeof window,o=function(){return window.location.pathname.replace(/\/$/,"")},r=function(e,t,n){return window.history.pushState(e,t,n)},i=function(e,t,n){return window.history.replaceState(e,t,n)},s=function(e){return window.addEventListener("popstate",e)},c=function(e){return window.removeEventListener("popstate",e)},u=function(e){var t=e.useHash?window.location.hash.replace(new RegExp("^#"+e.hashPrefix),""):window.location.pathname.replace(new RegExp("^"+e.base),"");return(t||"/")+window.location.search},l=function(){return window.history.state},p={};p=a?{getBase:o,pushState:r,replaceState:i,addPopstateListener:s,removePopstateListener:c,getLocation:u,getState:l}:{getBase:t(""),pushState:n,replaceState:n,addPopstateListener:n,removePopstateListener:n,getLocation:t(""),getState:t(null)};var f=p,d=f.pushState,v=f.replaceState,w=f.addPopstateListener,S=f.removePopstateListener,h=f.getLocation,g=f.getBase,m=f.getState,L="HISTORY",P=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=t.forceDeactivate;return function(t){t.getLocation=function(){return h(t.options)},t.replaceHistoryState=function(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=t.buildState(e,n),o=t.buildUrl(e,n);t.lastKnownState=a,v(a,"",o)};var a=function(e,t,n){n?v(e,"",t):d(e,"",t)},o=function(o){var r=!o.state||!o.state.name,i=r?t.matchPath(h(t.options)):o.state,s=t.options,c=s.defaultRoute,u=s.defaultParams;if(!i)return void(c&&t.navigate(c,u,{forceDeactivate:n,reload:!0,replace:!0}));if(!t.lastKnownState||!t.areStatesEqual(i,t.lastKnownState,!1)){var l=e["extends"]({},t.getState());t._transition(i,l,{forceDeactivate:n},function(e,o){if(e)if(e.redirect)t.navigate(e.redirect.name,e.redirect.params,{forceDeactivate:n,replace:!0});else if("CANNOT_DEACTIVATE"===e){var s=t.buildUrl(t.lastKnownState.name,t.lastKnownState.params);r||a(i,s,!0)}else c&&t.navigate(c,u,{forceDeactivate:n,reload:!0,replace:!0});else t._invokeListeners("$$success",o,l,{replace:!0})})}},r=function(){t.options.useHash&&!t.options.base&&(t.options.base=g()),w(o)},i=function(){S(o)},s=function(e,n,o){var r=m(),i=o.replace||n&&t.areStatesEqual(e,n,!1)||o.reload&&r&&t.areStatesEqual(e,r,!1);a(e,t.buildUrl(e.name,e.params),i)};return{name:L,onStart:r,onStop:i,onTransitionSuccess:s,onPopState:o}}};return P});